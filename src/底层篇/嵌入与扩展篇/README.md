# python性能优化

python语法优雅,但最让人诟病的是它的执行效率很低,基本属于各种编程语言中垫底的那一档.


## 过早优化是万恶之源

过早指的不是在开发过程的早期，而是在还没弄清楚需求未来的变化的走向的时候.你的优化不仅可能导致你无法很好地实现新的需求，而且你对优化的预期的猜测有可能还是错的，导致实际上你除了把代码变复杂以外什么都没得到.

就像我们小时候穿的衣服，妈妈总给我们买大一号的，可我的生长速度没那么快，每次都是穿烂了都还大.这就是过早优化的一个最典型例子.我们要评价一个东西好不好用,优不优秀,要先看它的使用场景,再结合场景讨论其功能效率.比如大家说日本刀好,但如果对抗重甲骑兵,日本刀就完全没法发挥.比如大家说f2隐形轰炸机好,先进.但如果让刚果这样的穷国家用他们更不用不起,也就谈不上好不好的问题了.


## 针对性能瓶颈优化项目


在工程上往往是够用就好,真正需要考虑性能的情况很少,真需要的时候往往也不是全盘优化,而是需要先分析性能瓶颈,再针对这些瓶颈进行优化重构.

往往这种方式20%的改善可以带来80%的速度提升.

定位瓶颈的方法可以看[工具链部分的相关内容](http://blog.hszofficial.site/TutorialForPython/%E5%B7%A5%E5%85%B7%E9%93%BE/%E8%B0%83%E8%AF%95%E4%B8%8E%E6%B5%8B%E8%AF%95.html#性能调优)


### 优先优化数据结构和算法

python虽慢但多数情况下想要达到它的性能极限是很困难的.语言本身往往并不是性能最大的瓶颈/更多的还是看算法和数据结构.python自带了很多优质的算法和数据结构实现,关于不同数据结构和算法可以看[数据结构与算法部分的结语](http://blog.hszofficial.site/TutorialForPython/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%BB%93%E8%AF%AD.html)

如果任务是io密集型可以使用协程解决.如果任务是计算密集型的可以使用多进程并行的计算.

### 优化文件读取

python常用于数据操作,在不考虑使用pandas等第三方包的情况下我们的目标是把文件中的表格数据转化为二维列表,这个操作一般可以用以下3种方式:

+ 干读干处理
+ 使用linecache模块读取然后处理
+ 干读+csv模块处理

使用csv包并不能提高处理csv格式文件的效率,而如果文件较大,使用linecache可以提高约10%~15%的i/o效率.

### 使用numba改造代码

numba是一个基于jit技术的装饰器工具,它可以为装饰的函数,类提供C语言的加速.

### 使用Cython改造特定代码

Cython实际上是一门用于沟通python和C/C++两种语言的编程语言，融合了python的灵活和C的静态快速.但是要注意python和C数据结构的区别，比如C的int和long有位数限制，而python的integer则无，为了表示较大的数，定义cython时long可用doubles来替换.

Cython的工作分为两种模式:

1. 为python模块做静态化声明,再通过翻译器将其翻译为C或者C++语言的源码,最后编译为python可调用的动态链接库作为python模块

2. 将C或者C++编写的模块接口封装成python可调用的动态链接库


## 正确的优化顺序

1. 有质量地实现你的需求,稳定需求和接口
2. 写够testcase
3. 做profile去找到性能的瓶颈
4. 检查是否使用了合适的数据结构和算法,有没有不利于性能的算法在其中
5. 如果是io密集型可以使用协程解决,如果是计算密集型任务考虑使用多进程重构.
6. 如果觉得依然效率达不到要求,可以使用Cython将需要改造的部分python代码静态化
7. 再还不行,可以使用C/C++重构需要优化部分的代码,然后通过Cython包装起来
8. 如果是计算密集型,并且有大量矩阵运算,可以考虑使用gpu运算
